#!/bin/bash
# shellcheck disable=SC1091
#
# Copyright Derek Macias (parts of code from NUT package)
# Copyright macester (parts of code from NUT package)
# Copyright gfjardim (parts of code from NUT package)
# Copyright SimonF (parts of code from NUT package)
# Copyright Lime Technology (any and all other parts of Unraid)
#
# Copyright desertwitch (as author and maintainer of this file)
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License 2
# as published by the Free Software Foundation.
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
NAME="sesmon"
COMMAND="/usr/bin/sesmon"
DOCROOT="/usr/local/emhttp/plugins/dwsesmon"

error_at_start() {
    touch $DOCROOT/start-failed

    source "/boot/config/plugins/dwsesmon/dwsesmon.cfg"
    if [ "$STARTNOTIFY" == "enable" ]; then
        NOTIFY="/usr/local/emhttp/plugins/dynamix/scripts/notify"
        HOST="$(echo "$HOSTNAME" | awk '{print toupper($0)}')"
        EVENT="SCSI Monitor Failure"
        SUBJECT="[${HOST}] SCSI Monitor Failure"
        MESSAGE="Service could not be started (check configuration and logs)."
        timeout -s9 10 "$NOTIFY" -e "${EVENT}" -s "Alert ${SUBJECT}" -d "${MESSAGE}" -i "alert"
    fi

    exit 1
}

start() {
    if pgrep -x "${NAME}" >/dev/null 2>&1; then
        echo "${NAME} is already running."
        return 0
    fi

    echo "Starting ${NAME}..."
    nohup "${COMMAND}" monitor /etc/sesmon/config.yaml </dev/null 2>&1 | logger -st "sesmon" >>/var/log/sesmon.log 2>&1 &

    sleep 2

    if pgrep -x "${NAME}" >/dev/null 2>&1; then
        echo "${NAME} started."
        return 0
    else
        echo "${NAME} failed to start."
        return 1
    fi
}

stop() {
    if ! pgrep -x "${NAME}" >/dev/null 2>&1; then
        echo "${NAME} is not running."
        return 0
    fi

    echo "Stopping ${NAME}..."
    killall ${NAME} >/dev/null 2>&1

    timeout=5
    while [ $timeout -gt 0 ]; do
        if ! pgrep -x "${NAME}" >/dev/null 2>&1; then
            echo "${NAME} stopped."
            return 0
        fi
        killall ${NAME} >/dev/null 2>&1
        sleep 1
        timeout=$((timeout - 1))
    done

    echo "${NAME} did not stop yet, forcing..."
    killall -9 ${NAME} >/dev/null 2>&1

    while pgrep -x "${NAME}" >/dev/null 2>&1; do
        killall -9 ${NAME} >/dev/null 2>&1
        sleep 1
    done

    echo "${NAME} stopped (forced)."
    return 0
}

status() {
    if pgrep -x "${NAME}" >/dev/null 2>&1; then
        echo "${NAME} is running."
        return 0
    else
        echo "${NAME} is not running."
        return 1
    fi
}

restart() {
    stop
    start
}

case "$1" in
    start)
        start || error_at_start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit $?
