Menu="dwses:2"
Title="Service Settings"
Tag="sliders"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsesmon/include/dwses_config.php';
require_once '/usr/local/emhttp/plugins/dwsesmon/include/dwses_helpers.php';

$lastStartFailed = false;
if (file_exists('/usr/local/emhttp/plugins/dwsesmon/start-failed')) {
    if (!$dwses_running) { $lastStartFailed = true; }
    unlink('/usr/local/emhttp/plugins/dwsesmon/start-failed');
}
?>

<?if ($lastStartFailed):?>
<div class="red-text" style="border: 1px solid red;padding: 5px;">
    sesmon was not able to start successfully - please check the <a href="/Tools/Syslog" target="_blank">SYSLOG</a> for more information.
</div><br>
<?endif;?>

<form markdown="0" id="dwses-settings" name="dwses_settings" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" id="dwses-set-file" name="#file" value="dwsesmon/dwsesmon.cfg">
    <input type="hidden" id="dwses-set-cmd" name="#command" value="/usr/local/emhttp/plugins/dwsesmon/scripts/none">

    <dl>
        <dt>Backend:</dt>
        <dd>
            <strong><?= isset($dwses_backend) && $dwses_backend ? $dwses_backend : "n/a" ?></strong>
        </dd>
    </dl>

    <dl>
        <dt><strong>Start Service:</strong></dt>
        <dd>
            <select id="SERVICE" name="SERVICE" size="1">
                <?=mk_option($dwses_service, "disable", "No");?>
                <?=mk_option($dwses_service, "enable", "Yes");?>
            </select>
            <?if(file_exists("/var/log/sesmon.log")):?>
            <a onclick="openTerminal('log','sesmon','sesmon.log')" style="color:inherit;margin-left:5px;cursor:help;">
                <i class="fa fa-book dwses-tip" title="sesmon Service Logs"></i>
                <?if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'7.1.99', '>')):?> sesmon Service Logs<?endif;?>
            </a>
            <?endif;?>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>This setting controls if the sesmon service should be started.</p>
    </blockquote>

    <dl>
        <dt>
            <span>
                <input id="CLEARDEVICES" class="dwses-tip" type="button" value="Clear Devices" title="Clear all devices from the dashboard (until next poll)">
                <input id="CLEARALARMS" class="dwses-tip" type="button" value="Clear Alarms" title="Clear all alarms from the dashboard (until next alarm">
                <input id="RESETCONF" class="dwses-run dwses-tip" type="button" value="Reset Config" title="Reverts the whole configuration to its default state, including the program configuration.">
            </span>
        </dt>
        <dd>
            <span>
                <input type="submit" id="btnApply" name="#apply" value="Apply">
                <input type="button" value="Done" onclick="done()">
                <input id="DEFAULT" type="submit" class="dwses-run dwses-tip" name="#default" value="Default" title="Reverts the displayed settings to their default values, but not the program configuration.">
                <input type="button" class="dwses-notrun dwses-tip" id="RESTART" value="Restart">
            </span>
        </dd>
    </dl>
</form>

<script>
function dwsesRunning() {
    if ($('#SERVICE').val() === 'enable') {
        $('#dwses-set-cmd').val('/usr/local/emhttp/plugins/dwsesmon/scripts/start');
    } else {
        $('#dwses-set-cmd').val('/usr/local/emhttp/plugins/dwsesmon/scripts/stop');
    }

    const dwses_running = <?= json_encode($dwses_running); ?>;

    if (dwses_running) {
        $('.dwses-run').prop('disabled', true);
        $('.dwses-notrun').prop('disabled', false);
    } else {
        $('.dwses-run').prop('disabled', false);
        $('.dwses-notrun').prop('disabled', true);
    }
}

function dwsesResetConfig() {
    $('#dwses-set-cmd').val('');
    openBox('/plugins/dwsesmon/scripts/resetconf', 'sesmon Configuration Reset', 600, 600, true);
}
$(function() {
    showStatus('sesmon');
    dwsesRunning();

    $('#SERVICE').change(dwsesRunning);

    $('#RESETCONF').click(function(){ swal({title:"Are you sure?",text:"This action will return any existing configuration to their defaults!",type:"warning",html:true,showCancelButton:true}, dwsesResetConfig); });

    $('#CLEARDEVICES').click(function(){
        $('#dwses-set-cmd').val('/usr/local/emhttp/plugins/dwsesmon/scripts/clear_devices');
        $('#dwses-settings').submit();
    });

    $('#CLEARALARMS').click(function(){
        $('#dwses-set-cmd').val('/usr/local/emhttp/plugins/dwsesmon/scripts/clear_alarms');
        $('#dwses-settings').submit();
    });

    $('#RESTART').click(function(){
        $('#dwses-set-cmd').val('/usr/local/emhttp/plugins/dwsesmon/scripts/restart');
        $('#dwses-settings').submit();
    });

    $('.dwses-tip').tooltipster({
        maxWidth: 300
    });

    if ( typeof caPluginUpdateCheck === "function" ) {
        caPluginUpdateCheck("dwsesmon.plg",{name:"sesmon"});
    }
});
</script>
