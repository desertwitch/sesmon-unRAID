Menu="Buttons:195"
Link="nav-user"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsesmon/include/dwses_helpers.php';

try {
    foreach (dwses_device_folders() as $dwses_folder_name => $dwses_folder_data) {
        $dwses_tile_name = "dwsesmon-" . $dwses_folder_name;

        $dwses_folder_parsed = [];
        if ($dwses_folder_data['parsed']) {
            $dwses_subdir = '/var/lib/sesmon/' . $dwses_folder_name;
            $dwses_folder_parsed = json_decode(file_get_contents($dwses_subdir . '/' . $dwses_folder_data['parsed']), true);
            if (json_last_error() !== JSON_ERROR_NONE) {
                $dwses_folder_parsed = [];
            }
        } else {
            continue;
        }

        $dwses_device_description = $dwses_folder_parsed['device']['description'] ?? '';

        $dwses_tile_text = "";
        if($dwses_device_description) {
            $dwses_tile_text = $dwses_device_description;
        } else {
            $dwses_tile_text = $dwses_folder_name;
        }

        if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'7.1.99', '>')) {
            // -------------------------------------------------------------
            // RESPONSIVE DASHBOARD
            // -------------------------------------------------------------
            $mytiles[$dwses_tile_name]['column2'] =
            <<<EOT
            <tbody id="{$dwses_tile_name}" title="SCSI Enclosure: {$dwses_folder_name}">
                <tr>
                    <td>
                        <span class='tile-header'>
                            <span class='tile-header-left'>
                                <i class='fa fa-server f32'></i>
                                <div class='section'>
                                    <h3 class='tile-header-main'>SCSI Enclosure: {$dwses_tile_text}</h3>
                                    <span id='{$dwses_folder_name}-header'>
                                        <i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em>
                                    </span>
                                </div>
                            </span>
                            <span class='tile-header-right'>
                                <span class='tile-ctrl'></span>
                                <span class='tile-header-right-controls'>
                                <a href='/Settings/dwses' title='_(Go to SCSI Enclosure Monitor Settings)_'>
                                    <i class='fa fa-fw fa-cog control'></i>
                                </a>
                                </span>
                            </span>
                        </span>
                    </td>
                </tr>
                <tr class='header'>
                    <td>
                        <span class='w18'>Alarms</span>
                        <span class='w18'>Critical</span>
                        <span class='w18'>Non-Critical</span>
                        <span class='w26'>Unrecoverable</span>
                        <span class='w18'>In Range (OK)</span>
                    </td>
                </tr>
                <tr id='{$dwses_folder_name}-body'>
                    <td style="text-align:center;">
                        <i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em>
                    </td>
                </tr>
            </tbody>
    EOT;
            } else {
            // -------------------------------------------------------------
            // NON-RESPONSIVE DASHBOARD
            // -------------------------------------------------------------
            $mytiles[$dwses_tile_name]['column2'] = <<<EOT
            <tbody id="{$dwses_tile_name}" title="SCSI Enclosure: {$dwses_folder_name}">
                <tr>
                    <td>
                        <i class="fa fa-server f32"></i>
                        <div class="section">
                            SCSI Enclosure: {$dwses_tile_text}<br>
                            <span id='{$dwses_folder_name}-header'>
                                <i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em>
                            </span>
                        </div>
                        <a href='/Settings/dwses' title="_(Go to SCSI Enclosure Monitor Settings)_">
                            <i class='fa fa-fw fa-cog control'></i>
                        </a>
                    </td>
                </tr>
                <tr class='header'>
                    <td>
                        <span class='w18'>Alarms</span>
                        <span class='w18'>Critical</span>
                        <span class='w18'>Non-Critical</span>
                        <span class='w26'>Unrecoverable</span>
                        <span class='w18'>In Range (OK)</span>
                    </td>
                </tr>
                <tr id='{$dwses_folder_name}-body'>
                    <td style="text-align:center;">
                        <i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em>
                    </td>
                </tr>
            </tbody>
    EOT;
            }
    }
} catch (\Throwable $t) {
    error_log($t);
}
?>

<script>
function dwsesFormatCount(count, color) {
    if (count > 0) {
        return '<span style="color:' + color + ';font-weight:bold;">' + count + '</span>';
    }
    return count;
}

function dwsesTimeAgo(timestamp, withColor) {
    if (timestamp == undefined || timestamp == null) return '';

    var then = new Date(timestamp);
    if (isNaN(then.getTime())) {
        return '';
    }

    var now = new Date();
    var diffMs = now - then;
    var diffMins = Math.floor(diffMs / 60000);

    var isStale = diffMins > 10;
    var timeClass = isStale ? 'red-text' : 'green-text';

    var timeText = '';
    if (diffMins < 1) {
        timeText = 'just now';
    } else if (diffMins < 60) {
        timeText = diffMins + ' min ago';
    } else {
        var hours = Math.floor(diffMins / 60);
        timeText = hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
    }

    if (withColor) {
        return '<span class="' + timeClass + '">(' + timeText + ')</span>';
    } else {
        return '<span>(' + timeText + ')</span>';
    }
}
function dwsesDashboards() {
    var basePath = '/plugins/dwsesmon/json';
    var cacheBust = '?v=' + Date.now();

    $.getJSON('/plugins/dwsesmon/include/dwses_list.php' + cacheBust)
        .done(function(freshData) {
            $.each(freshData, function(folderName, folderData) {
                if (!folderData.parsed) return;

                $.getJSON(basePath + '/' + folderName + '/' + folderData.parsed + cacheBust)
                    .done(function(data) {
                        var statusCounts = {
                            alarms: folderData.alerts.length,
                            critical: 0,      // status 2
                            noncritical: 0,   // status 3
                            unrecoverable: 0, // status 4
                            ok: 0            // status 1
                        };

                        if (data.raw) {
                            $.each(data.raw, function(elementId, element) {
                                if (!element || element.status === undefined) return;

                                var status = Number(element.status);

                                if (status === 2) statusCounts.critical++;
                                else if (status === 3) statusCounts.noncritical++;
                                else if (status === 4) statusCounts.unrecoverable++;
                                else if (status === 1) statusCounts.ok++;
                            });
                        }

                        if (statusCounts.alarms > 0) {
                            var alarmText = statusCounts.alarms + ' Alarm' + (statusCounts.alarms > 1 ? 's' : '');
                            $('#' + folderName + '-header').html(
                                '<span style="color:red;">' + alarmText + '</span> ' +
                                '| Last updated: ' + (data.captured_at || 'Unknown') + ' ' + dwsesTimeAgo(data.captured_at, true)
                            );
                        } else {
                            $('#' + folderName + '-header').html(
                                'Last updated: ' + (data.captured_at || 'Unknown') + ' ' + dwsesTimeAgo(data.captured_at, true)
                            );
                        }

                        $('#' + folderName + '-body').html(
                            '<td>' +
                                '<span class="w18">' + dwsesFormatCount(statusCounts.alarms, 'red') + ' Alarms</span>' +
                                '<span class="w18">' + dwsesFormatCount(statusCounts.critical, 'red') + ' Sensors</span>' +
                                '<span class="w18">' + dwsesFormatCount(statusCounts.noncritical, 'orange') + ' Sensors</span>' +
                                '<span class="w26">' + dwsesFormatCount(statusCounts.unrecoverable, 'darkred') + ' Sensors</span>' +
                                '<span class="w18">' + dwsesFormatCount(statusCounts.ok, 'green') + ' Sensors</span>' +
                            '</td>'
                        );
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Failed to update dashboard for ' + folderName + ':', textStatus, errorThrown);
                    });
            });
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Failed to fetch fresh folder list:', textStatus, errorThrown);
        });
}

$(function() {
    dwsesDashboards();
    timers.dwsesDashboards = setInterval(dwsesDashboards, 15000);
});
</script>
