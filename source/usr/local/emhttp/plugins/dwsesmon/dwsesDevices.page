Menu="dwses:2"
Title="Enclosure Devices"
Tag="server"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
?>
<style>
    .dwses-status-ok { color: green; }
    .dwses-status-critical { color: red; font-weight: bold; }
    .dwses-status-noncritical { color: orange; }
    .dwses-status-unrecoverable { color: darkred; font-weight: bold; }
    .dwses-status-unsupported { color: #999; }
    .dwses-status-not-installed { color: #999; }
    .dwses-status-unknown { color: #cc9900; }
    .dwses-status-not-available { color: #999; }
    .dwses-status-other { color: #999; }

    .dwses-device-section-header,
    .dwses-alert-section-header,
    .dwses-elements-section-header {
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        border-bottom: none;
        color: #333;
    }

    .dwses-device-section-header {
        font-size: 1.1em;
    }

    .dwses-alert-section-header,
    .dwses-elements-section-header {
        font-size: 1.0em;
    }

    .dwses-alert-file-header th {
        background-color: #fff3cd;
        font-weight: bold;
        border-top: 1px solid #ddd;
    }

    .dwses-status-summary {
        float: right;
        font-weight: normal;
    }

    .dwses-alert-count {
        color: red;
        font-weight: bold;
    }

    .dwses-time-ok {
        color: green;
    }

    .dwses-time-stale {
        color: red;
    }

    .dwses-device-section-header {
        cursor: pointer;
    }

    .dwses-device-content {
        display: none;
    }
</style>

<div id="dwses-content"></div>

<script>
try {
    function dwses_safe(val) {
        return (val !== undefined && val !== null) ? val : '';
    }

    function dwses_formatDate(date) {
        if (!date) return '';

        const dateObj = new Date(date);
        return isNaN(dateObj.getTime()) ? '' : dateObj.toLocaleString();
    }

    function dwses_sortElementId(a, b) {
        var parseId = function(id) {
            var parts = id.split('#');
            return [parseInt(parts[0]), parseInt(parts[1])];
        };

        var aParts = parseId(a);
        var bParts = parseId(b);

        if (aParts[0] !== bParts[0]) {
            return aParts[0] - bParts[0];
        }
        return aParts[1] - bParts[1];
    }

    function dwses_getTimeAgo(timestamp, withColor) {
        if (timestamp == undefined || timestamp == null) return '';

        var then = new Date(timestamp);
        if (isNaN(then.getTime())) {
            return '';
        }

        var now = new Date();
        var diffMs = now - then;
        var diffMins = Math.floor(diffMs / 60000);

        var isStale = diffMins > 10;
        var timeClass = isStale ? 'dwses-time-stale' : 'dwses-time-ok';

        var timeText = '';
        if (diffMins < 1) {
            timeText = 'just now';
        } else if (diffMins < 60) {
            timeText = diffMins + ' min ago';
        } else {
            var hours = Math.floor(diffMins / 60);
            timeText = hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
        }

        if (withColor) {
            return '<span class="dwses-time-ago ' + timeClass + '">(' + timeText + ')</span>';
        } else {
            return '<span class="dwses-time-ago">(' + timeText + ')</span>';
        }
    }

    function dwses_getStatusClass(status) {
        if (status == undefined || status == null) return '';

        var s = Number(status);
        if (s === 1) return 'dwses-status-ok';
        else if (s === 2) return 'dwses-status-critical';
        else if (s === 3) return 'dwses-status-noncritical';
        else if (s === 4) return 'dwses-status-unrecoverable';
        else if (s === 0) return 'dwses-status-unsupported';
        else if (s === 5) return 'dwses-status-not-installed';
        else if (s === 6) return 'dwses-status-unknown';
        else if (s === 7) return 'dwses-status-not-available';

        return '';
    }

    function dwses_toggleChevron(targetId) {
        var chevronId = targetId + '-chevron';

        if ($(targetId).is(':visible')) {
            $(chevronId).removeClass("fa-chevron-right").addClass("fa-chevron-down");
        } else {
            $(chevronId).removeClass("fa-chevron-down").addClass("fa-chevron-right");
        }
    }

    function dwses_buildDevice(folderName, data, alertDataArray, targetContainer) {
        var html = '';

        data = data || {};
        data.device = data.device || {};
        data.raw = data.raw || {};

        var deviceContentId = 'dwses-content-' + folderName;
        var alertSectionId = 'dwses-alerts-' + folderName;
        var elementsSectionId = 'dwses-elements-' + folderName;

        // Alerts section status counts (do this here because device section needs it)
        var totalAlerts = 0;
        var alertCounts = {2: 0, 3: 0, 4: 0, 1: 0, other: 0};
        $.each(alertDataArray, function(idx, alertData) {
            if (!alertData || !Array.isArray(alertData.changes)) {
                return;
            }

            totalAlerts += alertData.changes.length;

            $.each(alertData.changes, function(changeIdx, change) {
                if (!change || !change.after) return;

                var status = Number(change.after.status);

                if (status === 2) alertCounts[2]++;
                else if (status === 3) alertCounts[3]++;
                else if (status === 4) alertCounts[4]++;
                else if (status === 1) alertCounts[1]++;
                else alertCounts.other++;
            });
        });

        // Device section status counts
        var statusCounts = {1: 0, 2: 0, 3: 0, 4: 0, other: 0};
        $.each(data.raw, function(elementId, element) {
                if (!element || element.status === undefined || element.status === null) return;

            var status = Number(element.status);
            if (status in statusCounts) {
                statusCounts[status]++;
            } else {
                statusCounts.other++;
            }
        });

        var deviceSummary = [];
        if (totalAlerts > 0) deviceSummary.push('<span class="dwses-alert-count">' + totalAlerts + ' Alert' + (totalAlerts > 1 ? 's' : '') + '</span>');
        if (statusCounts[2] > 0) deviceSummary.push('<span class="dwses-status-critical">' + statusCounts[2] + ' Critical</span>');
        if (statusCounts[3] > 0) deviceSummary.push('<span class="dwses-status-noncritical">' + statusCounts[3] + ' Noncritical</span>');
        if (statusCounts[4] > 0) deviceSummary.push('<span class="dwses-status-unrecoverable">' + statusCounts[4] + ' Unrecoverable</span>');
        if (statusCounts[1] > 0) deviceSummary.push('<span class="dwses-status-ok">' + statusCounts[1] + ' OK</span>');
        if (statusCounts.other > 0) deviceSummary.push('<span class="dwses-status-other">' + statusCounts.other + ' Other</span>');

        var alertTimeHtml = '';
        if (alertDataArray.length > 0) {
            alertDataArray.sort(function(a, b) {
                return new Date(b.detected_at) - new Date(a.detected_at);
            });
            alertTimeHtml = ' - Alert: ' + dwses_formatDate(alertDataArray[0].detected_at) + ' ' + dwses_getTimeAgo(alertDataArray[0].detected_at, true);
        }

        // Device section header
        html += '<div class="dwses-device-section-header" data-toggle-id="' + deviceContentId + '" style="cursor: pointer;">';
        html += '<i class="fa fa-chevron-right" id="'+ deviceContentId +'-chevron"></i> ';
        html += (dwses_safe(data.device.description) || folderName) + ' ';
        html += '(' + dwses_safe(data.device.path) + ':' + dwses_safe(data.device.address) + ') - ';
        html += 'Updated: ' + dwses_formatDate(dwses_safe(data.captured_at)) + ' ' + dwses_getTimeAgo(data.captured_at, true) + alertTimeHtml;
        html += '<span class="dwses-status-summary">' + deviceSummary.join(' | ') + '</span>';
        html += '</div>';

        html += '<div id="' + deviceContentId + '" class="dwses-device-content">';

        // Alerts Section
        if (alertDataArray.length > 0) {
            var alertSummary = [];
            if (alertCounts[2] > 0) alertSummary.push('<span class="dwses-status-critical">' + alertCounts[2] + ' Critical</span>');
            if (alertCounts[3] > 0) alertSummary.push('<span class="dwses-status-noncritical">' + alertCounts[3] + ' Noncritical</span>');
            if (alertCounts[4] > 0) alertSummary.push('<span class="dwses-status-unrecoverable">' + alertCounts[4] + ' Unrecoverable</span>');
            if (alertCounts[1] > 0) alertSummary.push('<span class="dwses-status-ok">' + alertCounts[1] + ' OK</span>');
            if (alertCounts.other > 0) alertSummary.push('<span class="dwses-status-other">' + alertCounts.other + ' Other</span>');

            // Alerts section header
            html += '<div class="dwses-alert-section-header">';
            html += '<strong>ALERTS</strong> <span class="dwses-status-summary">' + alertSummary.join(' | ') + '</span>';
            html += '</div>';

            // Alerts section tables (one per alert)
            $.each(alertDataArray, function(idx, alertData) {
                if (!alertData || !Array.isArray(alertData.changes)) return;

                // Alert table header
                html += '<table class="dwses-alert-file-table tablesorter"><thead>';
                html += '<tr class="dwses-alert-file-header"><th colspan="10">';
                html += '<strong>Change Detected:</strong> ' + dwses_formatDate(dwses_safe(alertData.detected_at)) + ' ' + dwses_getTimeAgo(alertData.detected_at, false);
                html += '</th></tr>';
                html += '<tr>';
                html += '<th>Element ID</th><th>Description</th><th>Before Status</th><th>Before Desc</th><th>Before Flags</th>';
                html += '<th>Before Extra</th><th>After Status</th><th>After Desc</th><th>After Flags</th><th>After Extra</th></tr>';
                html += '</thead><tbody>';

                // Alert table rows (one per change)
                $.each(alertData.changes, function(changeIdx, change) {
                    if (!change) return;

                    var before = change.before || {};
                    var after  = change.after  || {};

                    var before_extra = [];
                    if (before.temperature) before_extra.push('Temp: ' + before.temperature);
                    if (before.voltage) before_extra.push('Volt: ' + before.voltage + 'V');
                    if (before.amperage) before_extra.push('Amp: ' + before.amperage + 'A');

                    var after_extra = [];
                    if (after.temperature) after_extra.push('Temp: ' + after.temperature);
                    if (after.voltage) after_extra.push('Volt: ' + after.voltage + 'V');
                    if (after.amperage) after_extra.push('Amp: ' + after.amperage + 'A');

                    html += '<tr class="alert-change-row">';
                    html += '<td>' + dwses_safe(change.id) + '</td><td>' + dwses_safe(change.element_type_desc) + '</td>';
                    html += '<td>' + dwses_safe(before.status) + '</td>';
                    html += '<td class="' + dwses_getStatusClass(before.status) + '">' + dwses_safe(before.status_desc) + '</td>';
                    html += '<td>P:' + dwses_safe(before.prdfail) + ' D:' + dwses_safe(before.disabled) + ' S:' + dwses_safe(before.swap) + '</td>';
                    html += '<td>' + before_extra.join(', ') + '</td>';
                    html += '<td>' + dwses_safe(after.status) + '</td>';
                    html += '<td class="' + dwses_getStatusClass(after.status) + '">' + dwses_safe(after.status_desc) + '</td>';
                    html += '<td>P:' + dwses_safe(after.prdfail) + ' D:' + dwses_safe(after.disabled) + ' S:' + dwses_safe(after.swap) + '</td>';
                    html += '<td>' + after_extra.join(', ') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';
            });
        }

        // Elements section status counts
        var elementSummary = [];
        if (statusCounts[2] > 0) elementSummary.push('<span class="dwses-status-critical">' + statusCounts[2] + ' Critical</span>');
        if (statusCounts[3] > 0) elementSummary.push('<span class="dwses-status-noncritical">' + statusCounts[3] + ' Noncritical</span>');
        if (statusCounts[4] > 0) elementSummary.push('<span class="dwses-status-unrecoverable">' + statusCounts[4] + ' Unrecoverable</span>');
        if (statusCounts[1] > 0) elementSummary.push('<span class="dwses-status-ok">' + statusCounts[1] + ' OK</span>');
        if (statusCounts.other > 0) elementSummary.push('<span class="dwses-status-other">' + statusCounts.other + ' Other</span>');

        // Elements sections header
        html += '<div class="dwses-elements-section-header">';
        html += '<strong>ELEMENTS</strong> <span class="dwses-status-summary">' + elementSummary.join(' | ') + '</span>';
        html += '</div>';

        // Elements table
        html += '<table class="dwses-elements-table tablesorter"><thead>';

        // Elements table header
        html += '<tr>';
        html += '<th>Element ID</th><th>Description</th><th>Status</th><th>Status Desc</th>';
        html += '<th>Prdfail</th><th>Disabled</th><th>Swap</th><th>Extra</th></tr>';
        html += '</thead><tbody>';

        // Elements table rows
        var sortedKeys = Object.keys(data.raw).sort(dwses_sortElementId);
        $.each(sortedKeys, function(index, elementId) {
            var element = data.raw[elementId];
            if (!element) return;

            var extra = [];
            if (element.temperature) extra.push('Temp: ' + element.temperature);
            if (element.voltage) extra.push('Volt: ' + element.voltage + 'V');
            if (element.amperage) extra.push('Amp: ' + element.amperage + 'A');

            html += '<tr><td>' + dwses_safe(elementId) + '</td><td>' + dwses_safe(element.element_type_desc) + '</td>';
            html += '<td>' + dwses_safe(element.status) + '</td>';
            html += '<td class="' + dwses_getStatusClass(element.status) + '">' + dwses_safe(element.status_desc) + '</td>';
            html += '<td>' + dwses_safe(element.prdfail) + '</td><td>' + dwses_safe(element.disabled) + '</td><td>' + dwses_safe(element.swap) + '</td>';
            html += '<td>' + extra.join(', ') + '</td></tr>';
        });

        html += '</tbody></table></div><br>';

        $(targetContainer).append(html);
    }

    let openDeviceIds = {};

    async function dwses_loadData() {
        const cacheBust = `?v=${Date.now()}`;
        const basePath = '/plugins/dwsesmon/json';
        const newContent = $('<div/>');

        $('[data-toggle-id]').each(function() {
            const targetId = '#' + $(this).data('toggle-id');
            if ($(targetId).is(':visible')) {
                openDeviceIds[targetId] = true;
            }
        });

        let res;
        try {
            res = await fetch(`/plugins/dwsesmon/include/dwses_list.php${cacheBust}`);
        } catch (e) {
            console.error('Failed to load folder list:', e);
            return;
        }
        if (!res.ok) {
            console.error('Failed to load folder list:', res.status, res.statusText);
            return;
        }
        const folders = await res.json();

        const folderArray = [];
        $.each(folders, function(folderName, folderData) {
            if (folderData.parsed) {
                folderArray.push({ folderName: folderName, folderData: folderData });
            }
        });
        if (folderArray.length === 0) {
            $('#dwses-content').html("<i>There are currently no enclosure device reports available.</i>");
            return;
        }

        const devicePromises = folderArray.map(async ({ folderName, folderData }) => {
            // Device data
            let deviceRes;
            try {
                deviceRes = await fetch(`${basePath}/${folderName}/${folderData.parsed}${cacheBust}`);
            } catch (e) {
                console.error(`Failed to load device data for ${folderName}:`, e);
                return;
            }
            if (!deviceRes.ok) {
                console.error(`Failed to load device data for ${folderName}:`, deviceRes.status, deviceRes.statusText);
                return;
            }
            const data = await deviceRes.json();

            // Device alerts data
            const alerts = folderData.alerts || [];
            let alertDataArray = [];

            if (alerts.length > 0) {
                const alertPromises = alerts.map(async (alertFile) => {
                    try {
                        const alertRes = await fetch(`${basePath}/${folderName}/${alertFile}${cacheBust}`);
                        if (!alertRes.ok) {
                            throw new Error(alertRes.statusText || 'Alert fetch failed');
                        }
                        return await alertRes.json();
                    } catch (e) {
                        console.warn(`Failed to load alert ${alertFile} for ${folderName}:`, e);
                        return null;
                    }
                });

                const alertResults = await Promise.all(alertPromises);
                alertDataArray = alertResults.filter(a => a !== null);
            }

            return { folderName, data, alertDataArray };
        });

        const results = (await Promise.all(devicePromises)).filter(r => r);

        results.sort(function(a, b) {
            return a.folderName.localeCompare(b.folderName, 'en', {
                numeric: true,
                sensitivity: 'base'
            });
        });

        results.forEach(result => {
            dwses_buildDevice(result.folderName, result.data, result.alertDataArray, newContent);
        });

        $('#dwses-content').html(newContent.html());

        $('.dwses-device-content').each(function() {
            const id = '#' + this.id;
            if (openDeviceIds[id]) {
                $(this).show();
                dwses_toggleChevron(id);
                delete openDeviceIds[id];
            } else {
                $(this).hide();
                dwses_toggleChevron(id);
            }
        });

        openDeviceIds = {};
    }

    $(document).ready(function() {
        dwses_loadData();
        timers.dwses_loadData = setInterval(dwses_loadData, 15000);

        $(document).on('click', '[data-toggle-id]', function() {
            var targetId = '#' + $(this).data('toggle-id');
            $(targetId).toggle();
            dwses_toggleChevron(targetId);
        });
    });
} catch (error) {
    console.error('dwsesmon devices error:', error);
}
</script>
