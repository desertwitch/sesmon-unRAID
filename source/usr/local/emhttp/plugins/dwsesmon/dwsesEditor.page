Menu="dwses:3"
Title="Service Configuration"
Tag="code"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
?>

<link type="text/css" rel="stylesheet" href="<?=autov('/webGui/styles/jquery.filetree.css');?>">
<link type="text/css" rel="stylesheet" href="<?=autov('/plugins/dwsesmon/css/codemirror.min.css');?>">
<link type="text/css" rel="stylesheet" href="<?=autov('/plugins/dwsesmon/css/dracula.min.css');?>">

<style type="text/css">
    .CodeMirror { border: 1px solid #eee; cursor: text; margin-top: 15px; margin-bottom: 10px; }
    .CodeMirror pre.CodeMirror-placeholder { color: #999; }
    .errortext {color: #EF3D47;display: none;}
    .fileTree {color:#486dba;width:305px;max-height:150px;overflow:scroll;position:absolute;z-index:100;display:none;}
</style>

<div style="margin-left:10px;">
<strong>SCSI Enclosures ( <code>lsscsi -g | grep enclosu</code> ):</strong>
<pre>
<?=shell_exec("lsscsi -g | grep enclosu")?:"(None found, but try the command without grep)";?>
</pre>

<strong>SCSI Enclosure Addresses ( <code>lsscsi -gt | grep enclosu</code> ):</strong>
<pre>
<?=shell_exec("lsscsi -tg | grep enclosu")?:"(None found, but try the command without grep)";?>
</pre>

<strong>Please refer to the <a href="https://github.com/desertwitch/sesmon#readme" target="_blank">documentation</a> for more information and example configurations.</strong>
<br><br>

<?php
function run_sesmon($cmd, $label) {
    $output = [];
    $return_var = 0;
    exec($cmd . ' 2>&1', $output, $return_var);
    $result = implode("\n", $output);

    if ($return_var === 0) {
        echo "<span style='color:green'><i class='fa fa-check-circle'></i> The {$label} has passed for the last saved configuration file.</span><br>";
    } else {
        echo "<span style='color:red'><i class='fa fa-times-circle '></i> The {$label} has failed for the last saved configuration file:<br><pre>" . htmlspecialchars($result) . "</pre></span>";
    }
}
run_sesmon('sesmon check /etc/sesmon/config.yaml', 'configuration check');
run_sesmon('sesmon test /etc/sesmon/config.yaml', 'configuration test');
?>

</div><br>

<form id="editform" method="POST">
    <img id="editfolder" style="cursor:pointer;margin-left:10px;" src="/webGui/images/explore.png" >

    <input id="editfile" type="text" name="editfile" value="" readonly="" data-picktop="/etc/sesmon" data-pickcloseonfile="true" data-pickfilter="yaml,sh" data-pickroot="/etc/sesmon" data-pickfolders="false" required="required" >

    <textarea id="editdata" name="editdata" placeholder="Select a configuration file to modify."></textarea>
    <input type="hidden" name="commit" value="1" />
    <dl>
        <dt></dt>
        <dd>
            <span>
                <input type="button" value="Save" id="btnSubmit" class="dwses-tip" title="Save the configuration changes." />
                <input type="button" value="Cancel" id="btnCancel" />
            </span>
        </dd>
    </dl>
</form>

<script src="<?=autov('/webGui/javascript/jquery.filetree.js');?>"></script>
<script src="<?=autov('/plugins/dwsesmon/js/codemirror.min.js');?>"></script>
<script src="<?=autov('/plugins/dwsesmon/js/autorefresh.min.js');?>"></script>
<script src="<?=autov('/plugins/dwsesmon/js/yaml.min.js');?>"></script>

<script>
$(function(){
    $('#btnCancel').click(function() {
        location = '/Settings/dwses';
    });

    var editor = CodeMirror.fromTextArea($('#editdata')[0], {
        theme: '<?=($display["theme"] == 'white' || $display["theme"] == 'azure') ? "default" : "dracula";?>',
        mode: 'yaml',
        lineNumbers: true,
        autoRefresh: true
    });

    editor.setSize(null, 600);

    $('#editfile').fileTreeAttach(null, null, function(file) {
        $('#editfile').val(file);
    });

    $('#editfile').on('change', function () {
        var Editfile = $('#editfile').val();
        $.getJSON('/plugins/dwsesmon/include/dwses_edit.php', {editfile: Editfile}, function (data) {
                editor.setValue(data);
            }
        );
    });

    $('#editfile').val("/etc/sesmon/config.yaml");
    var EditfileDefault = $('#editfile').val();
    $.getJSON('/plugins/dwsesmon/include/dwses_edit.php', {editfile: EditfileDefault}, function (data) {
            editor.setValue(data);
        }
    );

    $('#btnSubmit').click(function () {
        editor.save();
        $.post('/plugins/dwsesmon/include/dwses_save.php', $('#editform').serializeArray(), function (data) {
            var Title = 'Configuration ';

            if(data.success) {
                swal({title: Title+'Saved', text: data.saved+'\n\nIt will be active on next service restart.', timer: 2000, showConfirmButton: false, type:'success'}, function() {
                    location = '/Settings/dwses';
                });
            }
            if(data.error) {
                swal({title:Title+'Error', text: data.error+'\n\nThere was an error saving the configuration file.', timer: 3500, showConfirmButton: false, type:'error'});
            }

        }, 'json');
    });
});
</script>
